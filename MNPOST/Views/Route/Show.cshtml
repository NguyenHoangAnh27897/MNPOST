@{
    ViewBag.Title = "Show Route";
}
<div ng-app="myApp" ng-controller="myCtrl">
    <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2>Danh sách tuyến nhận/phát</h2>
                    <div class="clearfix"></div>
                </div>
                <!-- end x_title-->
                <div class="x_content">
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group">
                                <select class="form-control" ng-init="postChoose=''" ng-model="postChoose">
                                    <option ng-repeat="item in postOffices" value="{{item}}">{{item}}</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <button type="button" class="btn btn-primary" ng-click="getEmployeeRoutes(postChoose)">Lấy danh sách</button>
                        </div>
                    </div>

                    <!-- table data-->
                    <div class="table-responsive">
                        <table class="table table-striped jambo_table bulk_action">
                            <thead>
                                <tr class="headings">
                                    <th>STT</th>
                                    <th>Tên NV</th>
                                    <th>Mã NV</th>
                                    <th>Số tuyến phát</th>
                                    <th>Số tuyến nhận</th>
                                </tr>
                            </thead>

                            <tbody>
                                <tr ng-repeat="item in employeeRoutes">
                                    <td>{{$index + 1}}</td>
                                    <td>{{item.EmployeeName}}</td>
                                    <td>{{item.EmployeeID}}</td>
                                    <td>{{item.DistrictDelivery}}&nbsp;&nbsp;<a href="#" ng-click="showRouteManage('P', $index)">chỉnh sửa</a></td>
                                    <td>{{item.DistrictReceive}}&nbsp;&nbsp;<a href="#" ng-click="showRouteManage('N', $index)">chỉnh sửa</a></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- end table data-->
                </div>
                <!-- end x_content-->
            </div>
            <!-- end x_pannel-->
        </div>
    </div>

    <!-- quan ly tuyen-->
    <div id="routemodal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">{{modaltitle}}</h4>
                </div>

                <!-- body-->
                <div class="modal-body">
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group">
                                <select class="form-control" ng-model="provinceChoose">
                                    <option ng-repeat="item in provinces" value="{{item.code}}">{{item.name}}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <select class="form-control" ng-model="districtChoose">
                                    <option ng-repeat="item in districts" value="{{item.code}}">{{item.name}}</option>
                                </select>
                            </div>

                        </div>
                        <div class="col-sm-6">

                            <button type="button" class="btn btn-primary" ng-click="getDistrictRoutes()">XEM PHÂN TUYẾN</button>


                            <button class="btn btn-danger" type="button" ng-click="addDistrictRoute()">THÊM PHÂN TUYẾN</button>

                        </div>

                        <div class="col-sm-12">

                            <div class="x_title">
                                <h2><i class="fa fa-align-left"></i> Danh sách phân tuyến</h2>
                                <div class="clearfix"></div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <table class="table table-striped jambo_table bulk_action">
                                <thead>
                                    <tr class="headings">
                                        <th>STT</th>
                                        <th>Quận/huyện</th>
                                        <th>Phân rã</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="item in districtRoutes" >
                                        <td>{{$index + 1}}&nbsp;&nbsp;<a href="#" ng-click="removeMailer($index)"><i my-tool-tip="Xóa" class="fa fa-minus-square"></i></a></td>
                                        <td>{{item.DistrictName}}</td>
                                        <td><input type="checkbox" ng-model="item.IsDetail" />&nbsp;<button ng-show="item.IsDetail" class="btn btn-danger btn-xs" ng-click="showWardRoute($index)">Chọn phường</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-sm-6">
                            <table class="table table-striped jambo_table bulk_action">
                                <thead>
                                    <tr class="headings">
                                        <th>Chọn</th>
                                        <th>Phường/xã</th>
                                        <th>Quận huyện</th>
                                    </tr>
                                </thead>
                                <tbody>
             
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- end body-->

            </div>
            <!-- end modal content-->
        </div>
    </div>
    <!-- #end quan ly tuyen-->

</div>

@section styles {

    <style type="text/css">
        .scrollmenu {
            overflow: auto;
            white-space: nowrap;
            height: 300px;
        }
    </style>


}

<!-- end content-->
@section scripts {

    <script>

        // tao controller
        var app = angular.module('myApp', ['ui.bootstrap']);

        app.controller('myCtrl', function ($scope, $http) {

            $scope.postOffices = angular.fromJson(@Html.Raw(Json.Encode(ViewBag.AllPost)));
            $scope.provinces = angular.fromJson(@Html.Raw(Json.Encode(ViewBag.AllProvince)));
            $scope.employeeRoutes = [];
            $scope.modaltitle = '';
            $scope.eRoute = {};
            $scope.provinceChoose = '';
            $scope.districts = [];
            $scope.districtRoutes = [];
            $scope.districtChoose = '';

            $scope.getEmployeeRoutes = function (post) {
                console.log(post);
                if (post === '') {
                    alert('Chọn bưu cục');
                } else {
                    showLoader(true);
                    $http.get("/route/GetEmployeeRoutes?postId=" + post).then(function (response) {
                        showLoader(false);
                        $scope.employeeRoutes = angular.copy(response.data);
                    });

                }

            };

            $scope.showRouteManage = function (rType, idx) {
                $scope.provinceChoose = '';
                var employee = $scope.employeeRoutes[idx];
                $scope.eRoute = { EmployeeID: employee.EmployeeID, EmployeeName: employee.EmployeeName, Routetype: rType };
                $scope.modaltitle = (rType === 'N' ? 'Quản lý tuyến nhận nhân viên ' : 'Quản lý tuyến phát nhân viên ') + $scope.eRoute.EmployeeName;

                showModel('routemodal');

            };

            $scope.getDistrictRoutes = function () {
                if ($scope.provinceChoose !== '') {
                    showLoader(true);
                    $http.get("/route/GetDistrictRoutes?provinceId=" + $scope.provinceChoose + "&employeeId=" + $scope.eRoute.EmployeeID + "&type=" + $scope.eRoute.Routetype).then(function (response) {
                        $scope.districts = angular.copy(response.data.districts);

                        $scope.districtRoutes = angular.copy(response.data.routes);

                        showLoader(false);

                    });
                }
            };

            // tim index theo ma tinh
            function getDistrictIndex(id) {
                for (var i = 0; i < $scope.districts.length; i++)
                    if ($scope.districts[i].code == id)
                        return i;
                return -1;
            };

            $scope.addDistrictRoute = function () {

                if ($scope.provinceChoose === '' || $scope.districtChoose === '') {
                    alert('Thiếu thông tin');
                } else {

                    showLoader(true);

                    $http(
                        {
                            method: "POST",
                            url: "/route/AddDistrictRoutes",
                            data: {
                                provinceId: $scope.provinceChoose,
                                employeeId: $scope.eRoute.EmployeeID,
                                type: $scope.eRoute.Routetype,
                                district: $scope.districtChoose
                            }
                        }
                    ).then(function sucess(response) {

                        showLoader(false);

                        var data = response.data.data;

                        var districtIdx = getDistrictIndex($scope.districtChoose);

                        data.DistrictName = $scope.districts[districtIdx].name;

                        $scope.districtRoutes.push(data);

                        $scope.districts.splice(districtIdx, 1);
                        $scope.districtChoose = '';
                    }, function error(response) {
                        showLoader(false);
                        alert('disconnect internet')
                    });

                }

            };

        });
        //-- end controller

    </script>
}

